# CHAIN-007: 生年月日時表示の正確性 - E2Eテスト仕様書

**作成日**: 2025-11-11
**最終更新**: 2025-11-11
**ステータス**: 未実行

---

## 📋 テスト概要

### 目的
タイムゾーン変換（UTC+9 KST）の修正を検証し、入力した生年月日時が詳細ページとリストページで正しく表示されることを確認する。

### 背景
- **問題**: 入力した「1986年5月26日 05:00」が「1986年5月25日 20:00」と誤表示される
- **原因**: タイムゾーン変換（UTC+9）が正しく動作していない
- **修正**: バックエンドとフロントエンドのタイムゾーン処理を修正

### 修正ファイル
- `backend/app/api/saju.py` - タイムゾーン変換ロジック
- `frontend/src/utils/sajuHelpers.ts` - 日時表示フォーマット関数
- 運勢スクロールセクション（Year/Month/Day） - 表示改善

---

## 🧪 テストケース一覧

### 正常系（必須）- 5項目

#### E2E-CHAIN-007-S1: 朝の時刻（05:00）の表示確認

**優先度**: Critical
**実行時間**: 約10秒

**前提条件**:
- フロントエンド: http://localhost:3247 起動中
- バックエンド: http://localhost:8432 起動中
- LocalStorage: クリア済み

**テストステップ**:
1. トップページ（/）にアクセス
2. 名前を入力: 「テスト太郎」
3. 生年月日を入力: 1986年5月26日
4. 時刻を入力: 05:00
5. 性別を選択: 男性
6. 「命式を計算」ボタンをクリック
7. 詳細ページの基本情報欄を確認
8. ヘッダーの「リスト」ボタンをクリック
9. リストページのカードを確認

**期待結果**:
- 詳細ページ: 「1986年5月26日 5:00」と表示
- リストページ: 「1986年5月26日 5:00」と表示
- **NG例**: 「1986年5月25日 20:00」と表示される

**検証ポイント**:
- タイムゾーン変換が正しく動作している
- 先頭ゼロが省略されている（「05月」→「5月」、「05:00」→「5:00」）

---

#### E2E-CHAIN-007-S2: 昼の時刻（12:00）の表示確認

**優先度**: High
**実行時間**: 約10秒

**前提条件**:
- S1と同様

**テストステップ**:
1. トップページ（/）にアクセス
2. 名前を入力: 「テスト花子」
3. 生年月日を入力: 1990年3月15日
4. 時刻を入力: 12:00
5. 性別を選択: 女性
6. 「命式を計算」ボタンをクリック
7. 詳細ページとリストページで日時表示を確認

**期待結果**:
- 詳細ページ: 「1990年3月15日 12:00」と表示
- リストページ: 「1990年3月15日 12:00」と表示

---

#### E2E-CHAIN-007-S3: 夕方の時刻（18:00）の表示確認

**優先度**: High
**実行時間**: 約10秒

**前提条件**:
- S1と同様

**テストステップ**:
1. トップページ（/）にアクセス
2. 名前を入力: 「テスト次郎」
3. 生年月日を入力: 1995年6月20日
4. 時刻を入力: 18:00
5. 性別を選択: 男性
6. 「命式を計算」ボタンをクリック
7. 詳細ページとリストページで日時表示を確認

**期待結果**:
- 詳細ページ: 「1995年6月20日 18:00」と表示
- リストページ: 「1995年6月20日 18:00」と表示

---

#### E2E-CHAIN-007-S4: 深夜の時刻（23:30）の表示確認

**優先度**: High
**実行時間**: 約10秒

**前提条件**:
- S1と同様

**テストステップ**:
1. トップページ（/）にアクセス
2. 名前を入力: 「テスト春子」
3. 生年月日を入力: 2000年12月31日
4. 時刻を入力: 23:30
5. 性別を選択: 女性
6. 「命式を計算」ボタンをクリック
7. 詳細ページとリストページで日時表示を確認

**期待結果**:
- 詳細ページ: 「2000年12月31日 23:30」と表示
- リストページ: 「2000年12月31日 23:30」と表示
- **重要**: 翌日の「2001年1月1日」になっていないこと

---

#### E2E-CHAIN-007-S5: 詳細ページとリストページの表示一致確認

**優先度**: High
**実行時間**: 約15秒

**前提条件**:
- S1～S4のデータが保存されている状態

**テストステップ**:
1. リストページ（/list）にアクセス
2. 各カードに表示されている日時をメモ
3. 各カードをクリックして詳細ページに遷移
4. 詳細ページの日時表示を確認
5. リストページに戻る
6. 全てのカードで繰り返し

**期待結果**:
- 4件のデータ全てで、リストページと詳細ページの日時表示が一致
- フォーマットが統一されている

---

### エッジケース - 3項目

#### E2E-CHAIN-007-E1: タイムゾーン境界値（00:00）

**優先度**: Critical
**実行時間**: 約10秒

**前提条件**:
- S1と同様

**テストステップ**:
1. トップページ（/）にアクセス
2. 名前を入力: 「テスト境界0時」
3. 生年月日を入力: 2010年1月1日
4. 時刻を入力: 00:00
5. 性別を選択: 男性
6. 「命式を計算」ボタンをクリック
7. 詳細ページとリストページで日時表示を確認

**期待結果**:
- 詳細ページ: 「2010年1月1日 0:00」と表示
- リストページ: 「2010年1月1日 0:00」と表示
- **重要**: 前日の「2009年12月31日」になっていないこと

**検証ポイント**:
- タイムゾーン変換で日付が前日にズレていないか

---

#### E2E-CHAIN-007-E2: タイムゾーン境界値（23:59）

**優先度**: Critical
**実行時間**: 約10秒

**前提条件**:
- S1と同様

**テストステップ**:
1. トップページ（/）にアクセス
2. 名前を入力: 「テスト境界23時」
3. 生年月日を入力: 2010年12月31日
4. 時刻を入力: 23:59
5. 性別を選択: 女性
6. 「命式を計算」ボタンをクリック
7. 詳細ページとリストページで日時表示を確認

**期待結果**:
- 詳細ページ: 「2010年12月31日 23:59」と表示
- リストページ: 「2010年12月31日 23:59」と表示
- **重要**: 翌日の「2011年1月1日」になっていないこと

**検証ポイント**:
- タイムゾーン変換で日付が翌日にズレていないか

---

#### E2E-CHAIN-007-E3: 日付変更をまたぐ時刻の連続入力

**優先度**: Medium
**実行時間**: 約15秒

**前提条件**:
- S1と同様

**テストステップ**:
1. トップページ（/）にアクセス
2. 【1件目】名前: 「23時59分」、日時: 2015年6月15日 23:59、性別: 男性、計算
3. リストページに遷移
4. トップページに戻る
5. 【2件目】名前: 「0時0分」、日時: 2015年6月16日 00:00、性別: 女性、計算
6. リストページに遷移
7. 2件のカードの日時を確認

**期待結果**:
- 1件目: 「2015年6月15日 23:59」
- 2件目: 「2015年6月16日 0:00」
- 両方が正確に表示され、日付が正しい

---

### UI/UX（推奨）- 3項目

#### E2E-CHAIN-007-U1: 詳細ページの日時表示フォーマット

**優先度**: Medium
**実行時間**: 約5秒

**前提条件**:
- S1のデータが保存されている状態

**テストステップ**:
1. 詳細ページ（/saju/:id）にアクセス
2. 基本情報欄の日時表示を確認

**期待結果**:
- フォーマット: 「YYYY年M月D日 H:mm」
- 例: 「1986年5月26日 5:00」
- **NG例**: 「1986年05月26日 05:00」（先頭ゼロあり）

**検証ポイント**:
- 月と時刻の先頭ゼロが省略されている
- 日本語で読みやすい

---

#### E2E-CHAIN-007-U2: リストページの日時表示フォーマット

**優先度**: Medium
**実行時間**: 約5秒

**前提条件**:
- S1のデータが保存されている状態

**テストステップ**:
1. リストページ（/list）にアクセス
2. カードの日時表示を確認

**期待結果**:
- フォーマット: 詳細ページと同一
- カードに表示される日時が読みやすい
- テキストが省略されずに全文表示される

---

#### E2E-CHAIN-007-U3: 年月日運セクションでの日時表示

**優先度**: Low
**実行時間**: 約10秒

**前提条件**:
- S1のデータが保存されている状態

**テストステップ**:
1. 詳細ページ（/saju/:id）にアクセス
2. 年運セクションで大運カードをクリック
3. 年運カードが表示される
4. 月運セクションで年運カードをクリック
5. 月運カードが表示される
6. 日運セクションで月運カードをクリック
7. 日運カードが表示される

**期待結果**:
- 各運勢セクションで現在の年月日が正しく表示される
- タイムゾーンの影響を受けない
- カード内の日時表示が一貫している

---

## 📊 実行環境

### フロントエンド
- URL: http://localhost:3247
- ポート: 3247（CLAUDE.mdで定義）
- フレームワーク: React 19 + Vite 7

### バックエンド
- URL: http://localhost:8432
- ポート: 8432（CLAUDE.mdで定義）
- フレームワーク: FastAPI 0.109 + Python 3.9

### テストツール
- Playwright: v1.56.1
- ブラウザ: Chromium（ヘッドレスモード）

---

## 🔧 実装ファイル

### テストコード
- `frontend/tests/e2e/chain-007-birth-datetime-display.spec.ts`

### 手動テスト手順
- `frontend/tests/e2e/manual-birth-datetime-test.md`

---

## 📝 注意事項

### テスト実行前の準備
1. LocalStorageをクリア（`localStorage.clear()`）
2. フロントエンドとバックエンドが起動していることを確認
3. データベースが正常に接続されていることを確認

### デバッグ方法
- ブラウザのConsoleで以下を実行してデータを確認:
  ```javascript
  const data = JSON.parse(localStorage.getItem('saju_data') || '[]');
  console.log('LocalStorage data:', data);
  if (data.length > 0) {
    console.log('birthDatetime:', data[0].birthDatetime);
  }
  ```

### 既知の問題
- 修正前: 「1986年5月26日 05:00」→「1986年5月25日 20:00」（9時間ズレ）
- 修正後: 正しく表示されることを期待

---

**作成者**: E2Eテストオーケストレーター
**承認者**: （テスト実行後に記入）
**最終更新日**: 2025-11-11
