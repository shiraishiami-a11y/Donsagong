# ゴールデン四柱推命アプリケーション - 要件定義書

## 要件定義の作成原則
- **「あったらいいな」は絶対に作らない**
- **拡張可能性のための余分な要素は一切追加しない**
- **将来の「もしかして」のための準備は禁止**
- **今、ここで必要な最小限の要素のみ**

---

## 1. プロジェクト概要

### 1.1 成果目標
既存の210年節気データベース（1900-2109年）と検証済み万年暦計算システムを統合し、ゴールドテーマの美しいUIで四柱推命・大運・年月日運を網羅的に分析し、5段階吉凶判定と折れ線グラフで視覚化する個人利用型四柱推命Webアプリケーション。

**ブランド名**: Golden Peppa（ゴールデンペッパー）
**コンセプト**: 「あなたの運命に魔法をかける」
**シンボル**: ゴールデンペッパーミル + キラキラエフェクト
**デザインテーマ**: 伝統的な四柱推命に「魔法のような」親しみやすさとワクワク感を加えた、ゴールド×手書き風の現代的デザイン

### 1.2 成功指標

#### 定量的指標
- 命式計算の正確性：100%（210年データベース検証済み）
- 複数の命式を保存・管理できる（最低20件以上）
- 大運・年運・月運・日運すべてを1画面で確認可能
- 人生グラフ（大運ベース折れ線）の生成時間5秒以内
- 吉凶判定5段階（大吉・吉・平・凶・大凶）で明確に表示
- ローディングアニメーションの完全統合
- API応答時間：2秒以内
- ページ総数：6ページ（シンプル設計）

#### 定性的指標
- 誰でも簡単に命式を記入・保存できる
- ゴールドテーマで高級感とエレガンスを感じられる
- キラキラエフェクトで魔法をかけるような体験
- 複雑な運勢情報が視覚的にわかりやすい
- 五行カラーシステムで命式が一目瞭然
- 人生の波が美しいグラフで一目瞭然
- ログイン不要で即座に使える（ゲストモード）
- ログインすれば複数端末で同期可能
- ダウンロード後、個人環境で利用可能

---

## 2. システム全体像

### 2.1 主要機能一覧

#### カテゴリ1：命式管理
- 生年月日時入力と自動計算
- 複数命式の保存・編集・削除
- 命式一覧表示・検索・フィルタ

#### カテゴリ2：運勢分析
- 四柱推命表示（五行カラー統合）
- 大運分析（10年周期）
- 年運・月運・日運分析
- 5段階吉凶判定（大吉・吉・平・凶・大凶）
- 人生グラフ（大運ベース折れ線）

#### カテゴリ3：ユーザー管理
- ゲストモード（ローカルストレージ）
- ログインモード（クラウドDB同期）
- 自動ログイン機能（セッション保持）
- ゲスト→ログインユーザー移行

#### カテゴリ4：デザイン・UX
- ゴールドテーマ統合
- golden-peppaアニメーション
- キラキラエフェクト
- レスポンシブ対応

### 2.2 ユーザーロールと権限

#### ゲストユーザー
- **認証**: 不要
- **データ保存**: ローカルストレージのみ
- **アクセス範囲**: その端末のみ
- **アクセス可能な機能**:
  - 命式記入・計算・保存（ローカル）
  - 命式リスト表示（ローカルデータのみ）
  - 命式詳細・グラフ表示
  - 設定（限定機能）
- **制限**: 複数端末での同期不可、データはその端末のみ

#### ログインユーザー
- **認証**: メールアドレス＋パスワード
- **データ保存**: PostgreSQL（クラウドDB）
- **アクセス範囲**: どの端末からでもOK（Web・アプリ両対応）
- **アクセス可能な機能**:
  - すべてのゲスト機能
  - クラウドDB同期
  - 複数端末でのデータ共有
  - 自動ログイン（セッション保持）
  - データエクスポート/インポート
- **特典**: データバックアップ、永続保存

#### 管理者
- **不要**（個人利用のため）

### 2.3 認証・認可要件

#### 認証方式
- **メールアドレス＋パスワード**（ログインモードのみ）
- **ゲストモードは認証スキップ**

#### セッション管理
- **方式**: JWT (Access Token) + Refresh Token
- **Access Token**: 有効期限15分、API呼び出し時の認証
- **Refresh Token**: 有効期限7日/30日/無期限（ユーザー選択）
- **自動ログイン**: Refresh Tokenが有効なら自動認証
- **セキュリティ**: Refresh Token rotation、デバイス制限

#### セキュリティレベル
- **ゲストモード**: なし（ローカルのみ）
- **ログインモード**: 中レベル
  - パスワードハッシュ化（bcrypt）
  - HTTPS通信必須
  - user_id によるデータ分離
  - CORS設定
  - Rate Limiting

#### 管理機能
- **必要性**: 不要
- **理由**: 個人利用、ユーザー自身が全権限、管理画面不要

---

## 3. ページ詳細仕様

### 3.1 P-001: 命式記入ページ（トップページ）

#### ルート
`/`（ルートパス）

#### 権限
全員（ゲスト/ログインユーザー共通）

#### 目的
アプリを開いてすぐに命式を入力・計算できる。ログイン不要で即座に使える体験を提供。

#### 主要機能
- **初回訪問時**: ゴールドアニメーション表示（golden-peppa、短時間）
- **生年月日時入力フォーム**:
  - 西暦入力（1900-2109年）
  - 月・日・時・分の選択
- **性別選択**: 男性/女性（大運計算に必須）
- **名前入力**: 任意、管理用ラベル
- **「命式を計算」ボタン**: クリック時にキラキラエフェクト
- **ローディング表示**: golden-peppaアニメーション
- **計算結果プレビュー**:
  - 四柱表示（五行カラー）
  - 簡易吉凶表示
- **「保存」ボタン**: ゲストモードはローカル、ログインモードはクラウドDB
- **ヘッダー**:
  - 左: 「保存した命式」リンク（→P-002）
  - 右: ゲストモード「ログイン/登録」、ログインモード「設定」

#### 必要な操作（FastAPI）

| 操作種別 | エンドポイント | HTTPメソッド | 必要な入力 | 期待される出力 |
|---------|--------------|-------------|-----------|---------------|
| 計算 | `/api/saju/calculate` | POST | BirthDataRequest | SajuResponse |
| 保存 | `/api/saju/save` | POST | SajuData + user_id | SaveResponse |

#### 処理フロー
1. ユーザーが生年月日時・性別・名前を入力
2. 「命式を計算」ボタンクリック
3. ローディングアニメーション表示
4. バックエンドで四柱推命計算（lunar-python + 210年節気DB）
5. 大運計算（性別別、節入日ベース）
6. 5段階吉凶判定（天干・地支マトリックス）
7. 結果をプレビュー表示（五行カラー）
8. 「保存」で LocalStorage または PostgreSQL に保存

#### データ構造（Pydantic）
```python
class BirthDataRequest(BaseModel):
    birth_datetime: datetime
    gender: Literal['male', 'female']
    name: Optional[str] = None
    timezone_offset: int = 9  # KST

class SajuResponse(BaseModel):
    id: str
    name: Optional[str]
    birth_datetime: datetime
    gender: str
    year_stem: str
    year_branch: str
    month_stem: str
    month_branch: str
    day_stem: str
    day_branch: str
    hour_stem: str
    hour_branch: str
    daeun_list: List[DaeunInfo]
    fortune_level: str  # 大吉/吉/平/凶/大凶
    created_at: datetime
```

---

### 3.2 P-002: 命式リストページ

#### ルート
`/list`

#### 権限
全員（ゲスト/ログインユーザー共通）

#### 目的
保存した命式を一覧表示し、素早くアクセス・管理できる。

#### 主要機能
- **命式カード一覧表示**:
  - カード形式（Grid Layout）
  - 各カードに表示:
    - 名前（または「無題」）
    - 生年月日
  - ホバー時: キラキラエフェクト、カードが浮く
- ~~**検索機能**: 名前・生年月日で検索~~（削除）
- ~~**フィルタ機能**: 吉凶レベル別、性別~~（削除）
- **ソート機能**: 作成日、名前、生年月日
- **「新規作成」ボタン**: ゴールドカラー、クリックで→P-001
- **各カードのアクション**:
  - 「詳細」→P-003
  - 「編集」→P-001（編集モード）
  - 「削除」（確認ダイアログ付き）
- **ゲストモード専用バナー**:
  - 「アカウント作成でクラウドに保存！」
  - クリックで→P-AUTH-2

#### 必要な操作（FastAPI）

| 操作種別 | エンドポイント | HTTPメソッド | 必要な入力 | 期待される出力 |
|---------|--------------|-------------|-----------|---------------|
| 一覧取得 | `/api/saju/list` | GET | user_id（ログイン時） | List[SajuSummary] |
| 削除 | `/api/saju/{id}` | DELETE | id, user_id | DeleteResponse |

#### 処理フロー
1. ページロード時、ゲストモードはLocalStorageから、ログインモードはPostgreSQLから命式リスト取得
2. カード形式でシンプルに一覧表示（名前・生年月日のみ）
3. ソート機能で並び替え
4. カードクリックで詳細ページへ遷移
5. 削除時は確認ダイアログ表示後、削除実行

---

### 3.3 P-003: 命式詳細・グラフ表示ページ

#### ルート
`/detail/:id`

#### 権限
全員（ゲスト/ログインユーザー共通）

#### 目的
選択した命式の全情報を表示し、四柱・大運・年月日運・人生グラフを統合的に分析。

#### 主要機能

##### セクション1：基本情報
- 名前、生年月日時、性別
- 「編集」「削除」「リストに戻る」ボタン

##### セクション2：四柱表示
- **年柱・月柱・日柱・時柱**: 2列グリッド配置（モバイル最適化）
- **天干・地支を正方形ブロック（60px×60px）で五行カラー表示**:
  - 木（甲・乙・寅・卯・辰）: 緑色系 (#4CAF50)
  - 火（丙・丁・巳・午・未）: 赤色系 (#F44336)
  - 土（戊・己・辰・戌・丑・未）: 黄色/オレンジ系 (#FFB300)
  - 金（庚・辛・申・酉・戌）: 白/グレー系 (#BDBDBD)
  - 水（壬・癸・亥・子・丑）: 黒/ダークグレー系 (#424242)

##### セクション3：大運表示
- **大運セクションヘッダー情報**:
  - 年齢（大運数、順行/逆行）生後期間
  - 第一大運開始日
- **10年周期の大運一覧**: 縦並びタイムライン形式
- **各大運期の情報**:
  - 開始年齢のみ表示（例：8歳）
  - 十神（正官、偏財、食神など）
  - 天干・地支（五行カラー）
  - 吉凶レベル（5段階バッジ）
- **現在の大運ハイライト**: ゴールド背景＋「← 現在」マーカー

##### セクション4：人生グラフ
- **Recharts折れ線グラフ**:
  - 横軸: 年齢（0, 10, 20, 30...100歳、10年刻み）
  - 縦軸: 吉凶レベル（1-5）
  - データポイント: 大運開始年齢ごと（8, 18, 28, 38...98歳）
  - 線の色: ゴールドグラデーション
  - マーカー: 各大運期にゴールドドット
  - ツールチップ: ホバー時に詳細情報（年齢、大運、吉凶レベル）
  - グリッド: 薄いグレー、10年刻み
  - レスポンシブ対応
- **現在位置マーカー**: 赤い点線の縦線で現在年齢を示す

##### セクション5：年運・月運・日運
- **現在の年運・月運・日運**:
  - 天干・地支（五行カラー、正方形ブロック）
  - 吉凶レベル（5段階バッジ）
  - 簡易解説文
- **縦並びカード形式**（モバイル最適化）

~~##### セクション6：詳細分析~~
~~- **天干マトリックス分析**: 各柱間の関係性（吉凶判定）~~
~~- **地支調候表分析**: 季節と地支の関係~~
~~- **ドンサゴン解釈文**: 総合的な運勢解説~~
**（削除：詳細分析セクションは不要）**

#### 必要な操作（FastAPI）

| 操作種別 | エンドポイント | HTTPメソッド | 必要な入力 | 期待される出力 |
|---------|--------------|-------------|-----------|---------------|
| 詳細取得 | `/api/saju/{id}` | GET | id, user_id | SajuDetailResponse |
| 大運分析 | `/api/saju/{id}/daeun` | GET | id, user_id | DaeunAnalysisResponse |
| 年月日運 | `/api/saju/{id}/current` | GET | id, user_id, date | CurrentFortuneResponse |

#### 処理フロー
1. ページロード時、命式IDでデータ取得
2. 基本情報・四柱表示（五行カラー適用、正方形ブロック）
3. 大運計算結果を表示（大運数、順行/逆行、十神、5段階吉凶判定）
4. 現在日時で年運・月運・日運を計算・表示
5. Rechartsで人生グラフを描画（大運ベース、10年刻み）

#### データ構造（Pydantic）
```python
class DaeunInfo(BaseModel):
    start_age: int  # 開始年齢のみ（例：8、18、28...）
    daeun_stem: str
    daeun_branch: str
    sipsin: str  # 十神（正官、偏財、食神など）
    fortune_level: int  # 1-5

class SajuDetailResponse(BaseModel):
    # 基本情報
    id: str
    name: Optional[str]
    birth_datetime: datetime
    gender: str

    # 四柱
    year_stem: str
    year_branch: str
    month_stem: str
    month_branch: str
    day_stem: str
    day_branch: str
    hour_stem: str
    hour_branch: str

    # 大運
    daeun_number: int  # 大運数
    daeun_direction: str  # 順行 or 逆行
    birth_to_first_daeun_period: str  # 生後期間（例：7年5ヶ月2日）
    first_daeun_date: date  # 第一大運開始日
    daeun_list: List[DaeunInfo]

    # グラフデータ
    life_graph_data: List[GraphDataPoint]

class GraphDataPoint(BaseModel):
    age: int  # 大運開始年齢（例：8、18、28...）
    fortune_level: int  # 1-5
    daeun_stem: str
    daeun_branch: str
    sipsin: str  # 十神
    label: str  # "8歳: 丙午（正官）"
```

---

### 3.4 P-004: 設定ページ

#### ルート
`/settings`

#### 権限
全員（ゲスト/ログインユーザー、機能差あり）

#### 目的
アプリ設定とアカウント管理

#### 主要機能

##### セクション1：アカウント設定（ログインユーザーのみ）
- **メールアドレス表示**: 変更不可（将来対応）
- **パスワード変更**: フォーム表示
- **ログアウトボタン**: クリックでログアウト、ゲストモードに移行

##### セクション2：データ管理
- **ゲストモード**:
  - 「アカウント作成してクラウドに保存」ボタン
  - クリックで→P-AUTH-2（ゲストデータ移行オプション付き）
- **ログインモード**:
  - データエクスポート（JSON形式）
  - データインポート（バックアップから復元）

##### セクション3：自動ログイン設定（ログインユーザーのみ）
- **「ログイン状態を保持」トグル**: ON/OFF
- **セッション有効期限選択**:
  - 7日間
  - 30日間
  - 無期限

##### セクション4：表示設定
- **テーマ選択**: ゴールド（固定、将来的に他テーマ対応）
- **言語設定**: 日本語（固定、将来的に多言語対応）

##### セクション5：アプリ情報
- **バージョン情報**: v1.0.0
- **利用規約**: リンク（将来作成）
- **プライバシーポリシー**: リンク（将来作成）

#### 必要な操作（FastAPI）

| 操作種別 | エンドポイント | HTTPメソッド | 必要な入力 | 期待される出力 |
|---------|--------------|-------------|-----------|---------------|
| パスワード変更 | `/api/user/password` | PUT | old_password, new_password | UpdateResponse |
| データエクスポート | `/api/saju/export` | GET | user_id | JSON File |
| データインポート | `/api/saju/import` | POST | JSON File | ImportResponse |

---

### 3.5 P-AUTH-1: ログインページ

#### ルート
`/login`

#### 権限
ゲストのみ

#### 目的
ユーザー認証、クラウドDB同期の入口

#### 主要機能
- **メールアドレス入力フォーム**
- **パスワード入力フォーム**
- **「ログイン状態を保持」チェックボックス**: デフォルトON
- **「ログイン」ボタン**: ゴールドカラー
- **「パスワードを忘れた」リンク**: 将来対応
- **「新規登録はこちら」リンク**: →P-AUTH-2

#### 必要な操作（FastAPI）

| 操作種別 | エンドポイント | HTTPメソッド | 必要な入力 | 期待される出力 |
|---------|--------------|-------------|-----------|---------------|
| ログイン | `/api/auth/login` | POST | email, password | TokenResponse |

#### 処理フロー
1. メール・パスワード入力
2. 「ログイン状態を保持」チェック確認
3. 「ログイン」クリック
4. バックエンドで認証（bcryptでパスワード検証）
5. Access Token + Refresh Token発行
6. トークンをLocalStorageに保存
7. P-002（命式リスト）にリダイレクト

---

### 3.6 P-AUTH-2: 新規登録ページ

#### ルート
`/register`

#### 権限
ゲストのみ

#### 目的
アカウント作成、ゲストデータ移行

#### 主要機能
- **メールアドレス入力フォーム**
- **パスワード入力フォーム**（確認入力含む）
- **「ゲストデータを移行する」チェックボックス**: LocalStorageのデータをクラウドにアップロード
- **「登録」ボタン**: ゴールドカラー
- **「ログインはこちら」リンク**: →P-AUTH-1

#### 必要な操作（FastAPI）

| 操作種別 | エンドポイント | HTTPメソッド | 必要な入力 | 期待される出力 |
|---------|--------------|-------------|-----------|---------------|
| 新規登録 | `/api/auth/register` | POST | email, password | TokenResponse |
| データ移行 | `/api/saju/migrate` | POST | user_id, local_data | MigrateResponse |

#### 処理フロー
1. メール・パスワード入力
2. 「ゲストデータを移行する」チェック確認
3. 「登録」クリック
4. バックエンドでアカウント作成（パスワードハッシュ化）
5. Access Token + Refresh Token発行
6. ゲストデータ移行オプションがONの場合:
   - LocalStorageからデータ取得
   - PostgreSQLにアップロード
7. P-002（命式リスト）にリダイレクト

---

## 4. データ設計概要

### 4.1 主要エンティティ

```yaml
User（ユーザー）:
  概要: ログインユーザーのアカウント情報
  主要属性:
    - id（UUID、主キー）
    - email（メールアドレ、一意）
    - hashed_password（ハッシュ化パスワード）
    - created_at（作成日時）
    - updated_at（更新日時）
  関連:
    - SajuCalculation（1対多）

SajuCalculation（命式データ）:
  概要: 四柱推命の計算結果と基本情報
  主要属性:
    - id（UUID、主キー）
    - user_id（外部キー、NULL許可：ゲストモード対応）
    - name（名前、任意）
    - birth_datetime（生年月日時）
    - gender（性別）
    - year_stem, year_branch（年柱）
    - month_stem, month_branch（月柱）
    - day_stem, day_branch（日柱）
    - hour_stem, hour_branch（時柱）
    - fortune_level（吉凶レベル、5段階）
    - created_at（作成日時）
    - updated_at（更新日時）
  関連:
    - User（多対1）
    - DaeunInfo（1対多）

DaeunInfo（大運情報）:
  概要: 大運の詳細情報（10年周期）
  主要属性:
    - id（自動採番、主キー）
    - saju_id（外部キー）
    - start_age（開始年齢）
    - end_age（終了年齢）
    - daeun_stem（大運天干）
    - daeun_branch（大運地支）
    - fortune_level（吉凶レベル、5段階）
  関連:
    - SajuCalculation（多対1）

SolarTerm（節気データ）:
  概要: 210年節気データベース（1900-2109年）
  主要属性:
    - id（自動採番、主キー）
    - year（年）
    - term_name（節気名）
    - exact_datetime（正確な節入日時）
    - longitude（太陽黄経）
  関連: なし（参照専用）

CheonganMatrix（天干マトリックス）:
  概要: 天干100マトリックス（10×10）
  主要属性:
    - id（自動採番、主キー）
    - stem1（天干1）
    - stem2（天干2）
    - compatibility_type（吉凶タイプ）
    - description（説明）
    - score（スコア、1-5）
  関連: なし（参照専用）

JijiMatrix（地支マトリックス）:
  概要: 地支144マトリックス（12×12）
  主要属性:
    - id（自動採番、主キー）
    - branch1（地支1）
    - branch2（地支2）
    - compatibility_type（吉凶タイプ）
    - description（説明）
    - score（スコア、1-5）
  関連: なし（参照専用）
```

### 4.2 エンティティ関係図
```
User ─┬─ SajuCalculation ─┬─ DaeunInfo
      │                    │
      │                    └─ (参照) SolarTerm
      │                    └─ (参照) CheonganMatrix
      │                    └─ (参照) JijiMatrix
      │
      └─ (NULL許可: ゲストモード)
```

### 4.3 バリデーションルール

```yaml
生年月日時:
  - ルール: 1900-2109年の範囲内
  - 理由: 210年節気データベースの範囲

性別:
  - ルール: 'male' または 'female'
  - 理由: 大運計算に必須

メールアドレス:
  - ルール: 有効なメール形式、一意
  - 理由: ログイン認証に使用

パスワード:
  - ルール: 8文字以上
  - 理由: セキュリティ確保

吉凶レベル:
  - ルール: 1-5の整数
  - 理由: 5段階（大凶・凶・平・吉・大吉）
```

---

## 5. 制約事項

### 外部ライブラリ制限
- **lunar-python**: 1900-2100年範囲サポート（210年データベースは2109年まで対応）
- **PostgreSQL**: 同時接続制限あり（Neon無料枠: 1接続）

### 技術的制約
- **データ正確性**: 210年節気データベース範囲内（1900-2109年）でのみ100%正確
- **計算複雑度**: 大運・年月日運・グラフ計算で応答時間が増加する可能性
- **ローカルストレージ**: ブラウザデータクリアで消失

### ドンサゴン分析の絶対禁止事項
- ❌ 五行論（木火土金水、相生相剋）使用禁止
- ❌ 十神論（偏印、正財等）使用禁止
- ❌ 身強・身弱論使用禁止
- ❌ 年柱での用神抽出禁止
- ❌ 月地支は用神不可

### ドンサゴン分析の必須原則
- ✅ 用神 = 武器（不足を補うものではない）
- ✅ 日支の合は無条件吉
- ✅ 調候用神 80% : 原局 20%
- ✅ 天干の合は基本的に凶
- ✅ 月地支は用神不可

---

## 6. 複合API処理（バックエンド内部処理）

### 複合処理-001: 完全命式計算プロセス
**トリガー**: ユーザーが「命式を計算」ボタンクリック
**フロントエンドAPI**: `POST /api/saju/calculate`
**バックエンド内部処理**:
1. lunar-pythonで基本八字計算
2. 210年節気DBで正確な節入日確認
3. 月柱補正（節気境界チェック）
4. 大運計算（性別別、節入日ベース）
5. 天干マトリックス照合（吉凶判定）
6. 地支調候表照合（季節考慮）
7. 総合吉凶レベル算出（5段階）
**結果**: 完全な命式データ（四柱・大運・吉凶）
**外部サービス依存**: lunar-python, PostgreSQL（210年節気DB）

### 複合処理-002: 人生グラフデータ生成
**トリガー**: 命式詳細ページ（P-003）ロード
**フロントエンドAPI**: `GET /api/saju/{id}/daeun`
**バックエンド内部処理**:
1. 命式データ取得
2. 大運リスト取得（10年周期）
3. 各大運期の吉凶レベル計算
4. グラフデータポイント生成（年齢・吉凶レベル）
5. 現在年齢の算出とマーキング
**結果**: Recharts用データ配列
**外部サービス依存**: PostgreSQL

### 複合処理-003: 年月日運計算
**トリガー**: 命式詳細ページ（P-003）ロード
**フロントエンドAPI**: `GET /api/saju/{id}/current`
**バックエンド内部処理**:
1. 現在日時取得
2. 年運計算（現在年の干支）
3. 月運計算（現在月の干支）
4. 日運計算（現在日の干支）
5. 各運の吉凶レベル判定（5段階）
**結果**: 現在の年運・月運・日運データ
**外部サービス依存**: lunar-python, CheonganMatrix, JijiMatrix

### 複合処理-004: ゲストデータ移行
**トリガー**: 新規登録時「ゲストデータを移行する」チェックON
**フロントエンドAPI**: `POST /api/saju/migrate`
**バックエンド内部処理**:
1. フロントエンドからLocalStorageデータ受信
2. 各命式データをバリデーション
3. user_idを付与
4. PostgreSQLに一括挿入
5. トランザクション管理（全成功または全失敗）
**結果**: 移行完了通知
**外部サービス依存**: PostgreSQL

---

## 7. 技術スタック

### フロントエンド
```yaml
フレームワーク: React 18
言語: TypeScript 5
UIライブラリ: MUI v6 (Material-UI)
グラフ: Recharts v3.3.0
状態管理: Zustand
ルーティング: React Router v6
データフェッチ: React Query (TanStack Query)
ビルドツール: Vite 5
ホスティング: Vercel

カスタムテーマ:
  - ゴールドカラーパレット（#D4AF37）
  - 五行カラーシステム
  - golden-peppaアニメーション統合
```

### バックエンド
```yaml
言語: Python 3.11+
フレームワーク: FastAPI 0.100+
ORM: SQLAlchemy 2.0
マイグレーション: Alembic
バリデーション: Pydantic v2
認証: FastAPI-Users + JWT
ホスティング: GCP Cloud Run

既存資産統合:
  - lunar-python（万年暦計算）
  - 210年節気データベース（JSON → PostgreSQL）
  - ドンサゴン分析エンジン
```

### データベース
```yaml
メインDB: PostgreSQL 15+ (Neon)
キャッシュ: Redis (Upstash, オプション)
```

### 開発環境
```yaml
Python: 3.11+
Node.js: 20.x LTS
パッケージマネージャ:
  - Python: Poetry
  - JavaScript: pnpm
コード品質:
  - Python: Black, Ruff, mypy
  - TypeScript: ESLint, Prettier
```

---

## 8. 必要な外部サービス・アカウント

### 必須サービス

| サービス名 | 用途 | 取得先 | 備考 |
|-----------|------|--------|------|
| lunar-python | 万年暦計算ライブラリ | `pip install lunar-python` | 無料、1900-2100年対応 |
| Neon PostgreSQL | メインデータベース | https://neon.tech | 無料枠0.5GB、サーバーレス |
| Vercel | フロントエンドホスティング | https://vercel.com | 無料枠あり、自動デプロイ |
| GCP Cloud Run | バックエンドホスティング | https://cloud.google.com/run | 無料枠月2M req |
| GitHub | コード管理・CI/CD | https://github.com | 無料 |

### オプションサービス

| サービス名 | 用途 | 取得先 | 備考 |
|-----------|------|--------|------|
| Upstash Redis | キャッシュ | https://upstash.com | 無料枠あり、初期不要 |
| Sentry | エラー監視 | https://sentry.io | 無料枠あり、本番後推奨 |

---

## 9. 今後の拡張予定

### Phase 2（中期）
- パスワードリセット機能
- メールアドレス変更機能
- 他のデザインテーマ追加
- 多言語対応（英語・韓国語）

### Phase 3（長期）
- 相性診断機能（2人の命式比較）
- 年運詳細分析
- 択日システム
- モバイルアプリ版（React Native）

---

## 付録：デザイン仕様

### ゴールドカラーパレット（最終版 2025-11-07更新）
```yaml
# プライマリゴールド
PRIMARY_GOLD: #D4AF37      # メインゴールド - ボタン、アイコン、ブランディング
LIGHT_GOLD: #EBCC42        # ライトゴールド - セカンダリボタン、ハイライト
DARK_GOLD: #B8941C         # ダークゴールド - ボタンホバー、シャドウ
PALE_GOLD: #fffbf0         # ペールゴールド - 背景、ホバーエフェクト

# 背景
Background Primary: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%)
Card Background: #FFFFFF
```

### タイポグラフィ（最終版 2025-11-07更新）
```yaml
# ブランドフォント（Golden Peppa ロゴ専用）
Brand Font: 'Indie Flower', cursive
  - Google Fonts CDN: https://fonts.googleapis.com/css2?family=Indie+Flower
  - 特徴: 手書き風、親しみやすい、大人のカジュアル
  - 適用箇所: "Golden Peppa" ロゴタイトルのみ
  - サイズ: xs: 40px, md: 52px, lg: 68px
  - ウェイト: 400
  - レタースペーシング: 1px
  - 色: #D4AF37

# 本文フォント
Primary Font: 'Roboto', 'Noto Sans JP', sans-serif
  - 適用箇所: ボタン、フォーム、ナビゲーション、本文

# 四柱推命表示フォント（任意）
Secondary Font: 'Noto Serif JP', serif
  - 適用箇所: 天干・地支などの伝統的表記
```

### ビジュアルアセット（最終版 2025-11-07更新）
```yaml
# メインロゴ（現行）
Logo Image: /public/images/peppa-with-sparkles.png
  - 説明: ゴールデンペッパーミル + キラキラエフェクト統合画像
  - サイズ: xs: 160px, md: 200px, lg: 240px
  - 配置: 中央揃え（display: block, margin: auto）
  - 変更日: 2025-11-07
  - 変更理由: レイアウト安定性向上（5枚→1枚統合）

# 旧アセット（非推奨、ローディングアニメーションでのみ使用）
Old Assets:
  - /public/images/peppa.png
  - /public/images/キラキラ1.png
  - /public/images/キラキラ2.png
  - /public/images/キラキラ3.png
  - /public/images/キラキラ4.png
  - /public/images/左下光線.png
  - /public/images/右上光線.png
```

### 五行カラーシステム
```yaml
木: #4CAF50（緑）
火: #F44336（赤）
土: #FFB300（黄/オレンジ）
金: #BDBDBD（グレー/白）
水: #424242（黒/ダークグレー）
```

### 吉凶カラーシステム
```yaml
大吉: #FFD700（ゴールド）
吉: #4CAF50（緑）
平: #9E9E9E（グレー）
凶: #FF9800（オレンジ）
大凶: #F44336（赤）
```

---

## 10. インタラクティブ設計詳細仕様

### 10.1 アニメーション・エフェクト仕様

#### Golden Peppa ローディングアニメーション（最終版 2025-11-07更新）
- **使用場面**:
  - 命式計算中のローディング（TopPage）
  - データ保存中の待機画面
- **アニメーション構成**:
  - ペッパー画像の回転・スケール変動（4秒ループ、gentleShake）
  - 左下・右上光線の輝きエフェクト（3秒ループ、rayGlowPart）
  - キラキラ粒子の落下アニメーション（3.2秒ループ、sparkleFall）
  - ローディングドットのパルス（1.5秒ループ、dotPulse）
  - タイトル・タグラインのフェードイン（fadeInUp、0.5s/0.7s delay）
- **技術実装**: CSS keyframes + z-index階層管理
- **アセット**:
  - peppa.png（180x180px）
  - 左下光線.png（60x80px）
  - 右上光線.png（60x80px）
  - キラキラ1.png（25x25px）
  - キラキラ2.png（25x25px、opacity: 0.8）
  - キラキラ3.png（20x20px、45度回転）
  - キラキラ4.png（12.5x12.5px）
- **テキスト**:
  - "Golden Peppa"（48px、Indie Flower、#D4AF37）
  - "あなたの運命に魔法をかける"（14px、#666）

#### ボタンインタラクション（最終版 2025-11-07更新）
- **プライマリボタン（計算ボタン等）**:
  - 通常: background #D4AF37、color white、boxShadow 0 4px 12px rgba(212,175,55,0.3)
  - ホバー: background #B8941C、translateY(-2px)、boxShadow 0 6px 16px
  - クリック: translateY(0)
  - トランジション: 0.2秒
- **セカンダリボタン（保存・削除ボタン等）**:
  - 通常: background #EBCC42、color white、boxShadow none
  - ホバー: background #D4AF37
  - padding: 10px 24px
  - borderRadius: 8px
  - トランジション: 0.2秒
- **共通**:
  - textTransform: none（大文字化なし）
  - fontWeight: 600-700
  - Disabled状態: opacity 0.6、cursor not-allowed

#### カードホバーエフェクト
- **命式リストカード**:
  - 上昇: translateY(-2px)
  - ゴールドシャドウ: 0 4px 12px rgba(212, 175, 55, 0.2)
  - トランジション: 0.3秒
- **大運カード（選択可能）**:
  - 選択状態: ゴールド枠線 + 背景色変更
  - トランジション: スムーズな状態変化

#### ページ遷移アニメーション
- **状態**: 未実装（Phase 1で実装予定）
- **仕様案**: フェードイン + 上昇（500ms、ease-out）

### 10.2 ユーザーフィードバック仕様

#### Snackbar トースト通知
- **状態**: 未実装（Phase 1で実装必須）
- **使用場面**:
  - 命式保存成功時: 「命式を保存しました」（緑背景、3秒表示）
  - 削除成功時: 「削除しました」（緑背景、3秒表示）
  - エラー発生時: 「エラーが発生しました」（赤背景、5秒表示）
  - ログイン成功時: 「ログインしました」（緑背景、3秒表示）
- **配置**: 画面右上
- **自動消去**: 3-5秒
- **技術実装**: MUI Snackbar + Alert

#### エラー表示方法
- **フォームバリデーション**:
  - インラインエラー: FormHelperText（赤テキスト）
  - リアルタイム検証: onChange時に即座表示
  - 必須フィールド: アスタリスク表示
- **APIエラー**:
  - ネットワークエラー: Snackbar表示
  - バリデーションエラー: フォーム下部にAlert表示
  - 認証エラー: ダイアログ表示 + ログインページへ誘導

#### 削除確認ダイアログ
- **タイトル**: 「削除の確認」
- **メッセージ**: 「この命式を削除してよろしいですか？この操作は元に戻せません。」
- **ボタン**:
  - キャンセル: グレー、左配置
  - 削除: 赤、右配置
- **フェードイン**: MUIデフォルト動作

#### パスワード強度インジケーター
- **表示**: リアルタイムプログレスバー
- **色分け**:
  - 弱い（0-33%）: 赤 (#f44336)
  - 普通（34-66%）: オレンジ (#FFB300)
  - 強い（67-100%）: 緑 (#4CAF50)
- **条件**:
  - 弱い: 8文字未満、または単純パターン
  - 普通: 8文字以上、数字含む
  - 強い: 8文字以上、数字+記号含む

### 10.3 レスポンシブ動作仕様

#### ブレークポイント
- **xs**: 0-600px（スマートフォン）
- **sm**: 600-900px（タブレット縦）
- **md**: 900-1200px（タブレット横・小型デスクトップ）
- **lg**: 1200-1536px（デスクトップ）
- **xl**: 1536px+（大型デスクトップ）

#### レイアウト調整
- **命式リストページ**:
  - xs: 1列（Grid xs=12）
  - sm: 2列（Grid sm=6）
  - md: 3列（Grid md=4）
  - lg: 4列（Grid lg=3）
- **四柱表示**:
  - xs/sm: 2列（年月、日時で分割）
  - md+: 4列（年月日時並列）
- **フォームフィールド**:
  - xs: 1列（全フィールド縦並び）
  - sm+: 2列（生年月日を横並び）

#### タッチジェスチャー
- **状態**: 部分的実装（MUI標準機能のみ）
- **実装済み**:
  - タップ: ボタン・カードのクリック動作
  - スクロール: 縦横スクロール対応
- **未実装（Phase 2検討）**:
  - スワイプ: カード削除ジェスチャー
  - ピンチズーム: グラフ拡大

### 10.4 アクセシビリティ仕様

#### ARIA属性
- **現状**: 部分的実装（42%）
- **Phase 1で実装必須**:
  - `aria-label`: 全ボタン・アイコンに追加
  - `aria-describedby`: フォームヘルプテキスト関連付け
  - `aria-live`: 動的コンテンツ更新通知（Snackbar等）
  - `aria-busy`: ローディング状態表示

#### キーボードナビゲーション
- **Tab順序**: 論理的な順序（上→下、左→右）
- **フォーカス表示**: ゴールド枠線（2px solid #D4AF37）
- **Enter/Space**: ボタン・リンクの実行
- **Esc**: ダイアログ・モーダルの閉じる

#### スクリーンリーダー対応
- **代替テキスト**: 全画像にalt属性
- **セマンティックHTML**:
  - `<main>`: メインコンテンツ
  - `<nav>`: ナビゲーション
  - `<article>`: 命式カード
  - `<section>`: セクション区切り
- **ランドマーク**: role属性で明示

### 10.5 パフォーマンス仕様

#### ローディング状態管理
- **即座表示**: 100ms以内
- **アニメーション開始**: 200ms以内
- **長時間処理**: 1秒以上かかる場合はプログレスバー表示

#### 画像最適化
- **Golden Peppa画像**: WebP形式推奨、最大200KB
- **アイコン**: SVG使用推奨
- **遅延読み込み**: 画面外画像はlazy loading

#### アニメーション最適化
- **GPU加速**: transform, opacity のみ使用
- **FPS**: 60fps維持
- **減速モーション対応**: prefers-reduced-motion メディアクエリ

---

**作成日**: 2025年11月1日
**バージョン**: 1.0
**最終更新**: 2025年11月3日

---

## 🆕 機能拡張要件 - スマホレスポンシブ対応強化

**追加日**: 2025年11月5日  
**優先度**: High（既存機能の改善）  
**対象**: 全6ページのスマホ表示最適化

### 拡張概要
- **機能名**: 全ページのスマホレスポンシブ対応強化
- **目的**: スマホでの操作性・視認性を大幅改善
- **解決する課題**:
  - ボタンが小さくてタップしづらい
  - フォントサイズが小さくて読みづらい
  - 横スクロールが全く効かない（Critical）
  - グラフが横に長すぎて使いづらい
- **期待効果**:
  - タップ成功率の向上（Apple HIG準拠）
  - 文字視認性の向上（最小フォントサイズ14px）
  - 横スクロールの正常動作（iOS/Android対応）
  - スクロール距離の短縮（1200px → 800px、約33%削減）

### 既存システムとの関係
- **影響を受ける既存機能**: 全6ページのUI表示
  - TopPage（命式記入）
  - LoginPage、RegisterPage
  - ListPage（命式一覧）
  - SajuDetailPage（命式詳細）
  - SettingsPage
- **共有するデータ**: なし（UIのみの変更）
- **統合ポイント**: MUI sx プロパティのみ変更、ロジックは不変

### 新規追加要素

#### 画面設計
- **新規ページ**: なし
- **既存ページ改修**: 全6ページ
  - TopPage: 性別ボタン・エラーメッセージのサイズ調整
  - ListPage: ヘッダーアイコン・カードのサイズ調整
  - SajuDetailPage: ヘッダーボタン・四柱表示・グラフ・横スクロール修正
  - SettingsPage: レスポンシブ対応追加
  - LoginPage/RegisterPage: リンク・インジケータのサイズ調整
  - HomePage: **削除**（TopPageに統一）

#### API設計
- **新規エンドポイント**: なし
- **既存エンドポイント変更**: なし

#### データモデル
**変更なし**（UIのみの修正）

---

### 実装計画

#### 修正範囲
- **合計修正項目**: 21件
  - Critical: 6件（横スクロール修正含む）
  - High: 15件（フォントサイズ・ボタンサイズ等）
- **修正ファイル数**: 11ファイル
- **削除ファイル数**: 1ファイル（HomePage.tsx）

#### Phase 1: Critical修正（必須、約1時間10分）

##### 1-1. 横スクロール修正（最優先）
**問題**: スマホで全ての横スクロールが効かない

**修正箇所1**: `frontend/src/pages/SajuDetailPage/index.tsx` (152行目)
```tsx
// 修正前
<Box sx={{ maxWidth: { xs: '100%', sm: '900px', lg: '1400px' } }}>

// 修正後（xsを削除）
<Box sx={{ maxWidth: { sm: '900px', lg: '1400px' } }}>
```

**修正箇所2-4**: Year/Month/Day ScrollSection（各95行目付近）
```tsx
// 修正前
sx={{ overflowX: 'auto', pb: 1.5 }}

// 修正後（iOS対応）
sx={{ overflowX: 'auto', WebkitOverflowScrolling: 'touch', pb: 1.5 }}
```

##### 1-2. グラフ横スクロール短縮
**ファイル**: `frontend/src/pages/SajuDetailPage/LifeGraphSection.tsx` (81行目)
```tsx
// 修正前
minWidth: '1200px'

// 修正後
minWidth: { xs: '800px', sm: '1000px', lg: '1200px' }
```

##### 1-3. ヘッダーボタンサイズ修正
**ファイル**: `frontend/src/pages/SajuDetailPage/index.tsx` (164-219行目)
```tsx
// 保存ボタン
fontSize: { xs: '16px', sm: '18px' }  // 14px → 16px
padding: { xs: '14px 24px', sm: '16px 28px' }
minHeight: '48px'

// 閉じるボタン
width: { xs: '48px', sm: '52px' }  // 40px → 48px
height: { xs: '48px', sm: '52px' }
```

##### 1-4. アイコンボタンサイズ修正
**ファイル**: `frontend/src/pages/ListPage/index.tsx` (151-165行目)
```tsx
<IconButton sx={{ width: 48, height: 48 }}>
```

##### 1-5. 設定ページレスポンシブ対応
**ファイル**: `frontend/src/pages/SettingsPage.tsx` (52-126行目)
```tsx
// Container
maxWidth: { xs: '100%', md: '900px', lg: '1400px' }
px: { xs: '20px', md: '24px', lg: '40px' }

// Paper
p: { xs: 2, sm: 3, md: 4 }

// タイトル
fontSize: { xs: '24px', md: '28px', lg: '32px' }
```

##### 1-6. HomePage削除
**ファイル**: `frontend/src/pages/HomePage.tsx`
- **削除理由**: 未実装、TopPageが既にトップページとして機能
- **ルーティング確認**: `/` → TopPage（確認済み）

---

#### Phase 2: High修正（推奨、約2-3時間）

##### 2-1. TopPage改善（2箇所、8分）
- 性別選択ボタン: padding `{ xs: '18px', md: '22px' }`, minHeight `48px`
- エラーメッセージ: fontSize `{ xs: '14px', sm: '15px' }`

##### 2-2. ListPage改善（2箇所、6分）
- 空状態アイコン: fontSize `{ xs: 48, md: 60, lg: 80 }`
- 新規作成ボタン: fontSize `{ xs: '16px', md: '18px' }`

##### 2-3. SajuCard改善（2箇所、8分）
- 四柱ミニ表示: fontSize `{ xs: '16px', md: '18px', lg: '20px' }`
- 削除ボタン: width/height `{ xs: 44, md: 48 }`

##### 2-4. PillarsSection改善（2箇所、8分）
- 天干地支: fontSize `{ xs: '24px', sm: '36px', lg: '44px' }`
- ラベル: fontSize `{ xs: '12px', sm: '15px' }`

##### 2-5. DaeunScrollSection改善（2箇所、8分）
- カード最小幅: minWidth `{ xs: '120px', sm: '160px' }`
- 天干地支: width/height `{ xs: '56px', sm: '64px', md: '72px' }`

##### 2-6. LoginPage改善（1箇所、5分）
- パスワード忘れたリンク: fontSize `{ xs: '15px', sm: '17px' }`, padding `8px 0`

##### 2-7. RegisterPage改善（2箇所、8分）
- 利用規約リンク: fontSize `{ xs: '15px', sm: '17px' }`, padding `4px 0`
- パスワード強度: height `{ xs: '6px', sm: '8px' }`

---

### 実装基準

#### Apple Human Interface Guidelines準拠
- **最小タップ領域**: 44pt (Web換算48px推奨)
- **最小フォントサイズ**: 12px（14px以上推奨）

#### MUIブレークポイント統一
- **xs**: 0-599px（スマホ）
- **sm**: 600-899px（タブレット縦）
- **md**: 900-1199px（タブレット横）
- **lg**: 1200px+（PC）

#### レスポンシブ指定ルール
- 基本は `{ xs, md, lg }` の3段階
- `sm` は必要に応じて追加（600-899pxで特別な調整が必要な場合）

---

### 制約事項・リスク

#### 技術的制約
- **後方互換性**: 既存のPC表示は変更なし（sm/md/lg維持）
- **パフォーマンス**: CSS変更のみ、描画パフォーマンスへの影響なし
- **セキュリティ**: 変更なし

#### ビジネス制約
- **リリース期限**: なし（段階的リリース可能）
- **予算**: なし（既存リソースのみ）

#### リスクと対策
| リスク | 評価 | 対策 |
|--------|------|------|
| PC表示の崩れ | 低 | sm/md/lgは変更なし |
| E2Eテスト失敗 | 低 | セレクタ変更なし、実行後確認 |
| レイアウト崩れ | 中 | 各ブレークポイントで目視確認 |
| 横スクロール再発 | 低 | 親コンテナのmaxWidth管理徹底 |

---

### テスト計画

#### E2Eテスト
- **既存33項目を全実行**
- **予想結果**: 全Pass（セレクタ変更なし）
- **失敗時**: スクロール処理・wait処理を追加

#### 実機テスト（推奨）
- **iPhone SE（375px）**: 最小サイズ確認
- **iPhone 14 Pro（393px）**: 標準サイズ確認
- **iPad mini（768px）**: タブレット確認

#### 確認項目
- [ ] タップ領域が44px以上
- [ ] フォントが読みやすい（14px以上）
- [ ] 横スクロールが滑らか
- [ ] レイアウト崩れなし

---

### 完了チェックリスト
- [ ] Critical 6件の修正完了
- [ ] High 15件の修正完了
- [ ] HomePage削除完了
- [ ] E2Eテスト全Pass
- [ ] 実機テスト完了（推奨）
- [ ] 横スクロール動作確認
- [ ] リファクタリング不要（UIのみ変更）
- [ ] ドキュメント更新（本要件定義）

---

**注**: 実装完了後は該当部分を削除し、コードを真実源とする

