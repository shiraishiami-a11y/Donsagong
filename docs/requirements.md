# ゴールデン四柱推命アプリケーション - 要件定義書

## 要件定義の作成原則
- **「あったらいいな」は絶対に作らない**
- **拡張可能性のための余分な要素は一切追加しない**
- **将来の「もしかして」のための準備は禁止**
- **今、ここで必要な最小限の要素のみ**

---

## 1. プロジェクト概要

### 1.1 成果目標
既存の210年節気データベース（1900-2109年）と検証済み万年暦計算システムを統合し、ゴールドテーマの美しいUIで四柱推命・大運・年月日運を網羅的に分析し、5段階吉凶判定と折れ線グラフで視覚化する個人利用型四柱推命Webアプリケーション。

**ブランド名**: Golden Peppa（ゴールデンペッパー）
**コンセプト**: 「あなたの運命に魔法をかける」
**シンボル**: ゴールデンペッパーミル + キラキラエフェクト
**デザインテーマ**: 伝統的な四柱推命に「魔法のような」親しみやすさとワクワク感を加えた、ゴールド×手書き風の現代的デザイン

### 1.2 成功指標

#### 定量的指標
- 命式計算の正確性：100%（210年データベース検証済み）
- 複数の命式を保存・管理できる（最低20件以上）
- 大運・年運・月運・日運すべてを1画面で確認可能
- 人生グラフ（大運ベース折れ線）の生成時間5秒以内
- 吉凶判定7段階（大吉・小吉・吉・吉凶・平・凶・大凶）で明確に表示
- ユーザーの日干を基準にした正確な吉凶判定
- ローディングアニメーションの完全統合
- API応答時間：2秒以内
- ページ総数：6ページ（シンプル設計）
- モバイルレスポンシブ対応完了（xs/sm/md各ブレークポイント最適化）

#### 定性的指標
- 誰でも簡単に命式を記入・保存できる
- ゴールドテーマで高級感とエレガンスを感じられる
- キラキラエフェクトで魔法をかけるような体験
- 複雑な運勢情報が視覚的にわかりやすい
- 五行カラーシステムで命式が一目瞭然
- 人生の波が美しいグラフで一目瞭然
- ログイン不要で即座に使える（ゲストモード）
- ログインすれば複数端末で同期可能
- ダウンロード後、個人環境で利用可能

---

## 2. システム全体像

### 2.1 主要機能一覧

#### カテゴリ1：命式管理
- 生年月日時入力と自動計算
- 複数命式の保存・編集・削除
- 命式一覧表示・検索・フィルタ

#### カテゴリ2：運勢分析
- 四柱推命表示（五行カラー統合、モバイル最適化済み）
- 大運分析（10年周期、開始年齢表記）
- 年運・月運・日運分析（水平スクロール対応）
- 7段階吉凶判定（大吉・小吉・吉・吉凶・平・凶・大凶）
- ユーザーの日干を基準にした正確な吉凶判定
- 人生グラフ（大運ベース折れ線、レスポンシブ対応）

#### カテゴリ3：ユーザー管理
- ゲストモード（ローカルストレージ）
- ログインモード（クラウドDB同期）
- 自動ログイン機能（セッション保持）
- ゲスト→ログインユーザー移行

#### カテゴリ4：デザイン・UX
- ゴールドテーマ統合（Golden Peppa）
- golden-peppaアニメーション（ローディング）
- キラキラエフェクト
- レスポンシブ対応（完全実装済み）
- 統一デザインシステム（cardStyles.ts）
- 命式表示の視認性向上（1.5倍拡大）
- タップ領域最適化（Apple HIG準拠、最小48px）

### 2.2 ユーザーロールと権限

#### ゲストユーザー
- **認証**: 不要
- **データ保存**: ローカルストレージのみ
- **アクセス範囲**: その端末のみ
- **アクセス可能な機能**:
  - 命式記入・計算・保存（ローカル）
  - 命式リスト表示（ローカルデータのみ）
  - 命式詳細・グラフ表示
  - 設定（限定機能）
- **制限**: 複数端末での同期不可、データはその端末のみ

#### ログインユーザー
- **認証**: メールアドレス＋パスワード
- **データ保存**: PostgreSQL（クラウドDB）
- **アクセス範囲**: どの端末からでもOK（Web・アプリ両対応）
- **アクセス可能な機能**:
  - すべてのゲスト機能
  - クラウドDB同期
  - 複数端末でのデータ共有
  - 自動ログイン（セッション保持）
  - データエクスポート/インポート
- **特典**: データバックアップ、永続保存

#### 管理者
- **不要**（個人利用のため）

### 2.3 認証・認可要件

#### 認証方式
- **メールアドレス＋パスワード**（ログインモードのみ）
- **ゲストモードは認証スキップ**

#### セッション管理
- **方式**: JWT (Access Token) + Refresh Token
- **Access Token**: 有効期限15分、API呼び出し時の認証
- **Refresh Token**: 有効期限7日/30日/無期限（ユーザー選択）
- **自動ログイン**: Refresh Tokenが有効なら自動認証
- **セキュリティ**: Refresh Token rotation、デバイス制限

#### セキュリティレベル
- **ゲストモード**: なし（ローカルのみ）
- **ログインモード**: 中レベル
  - パスワードハッシュ化（bcrypt）
  - HTTPS通信必須
  - user_id によるデータ分離
  - CORS設定
  - Rate Limiting

#### 管理機能
- **必要性**: 不要
- **理由**: 個人利用、ユーザー自身が全権限、管理画面不要

---

## 3. ページ詳細仕様

### 3.1 全6ページ実装状況

**✅ 全ページ実装完了（コードが真実源）**

| ページ | ルート | 実装状況 |
|--------|--------|----------|
| 命式記入ページ | `/` | ✅ 完了 |
| 命式リストページ | `/list` | ✅ 完了 |
| 命式詳細ページ | `/detail/:id` | ✅ 完了 |
| 設定ページ | `/settings` | ✅ 完了 |
| ログインページ | `/login` | ✅ 完了 |
| 新規登録ページ | `/register` | ✅ 完了 |

#### 今後の拡張機能（Phase 2以降）
- パスワードリセット機能（未実装）
- パスワード変更機能（エンドポイント未実装）
- セッション有効期限選択UI（未実装）

---

## 4. データモデル実装状況

**✅ 全モデル実装完了（コードが真実源: `backend/app/models/__init__.py`）**

| モデル名 | テーブル名 | 実装状況 |
|----------|------------|----------|
| User | users | ✅ 完了 |
| Saju | saju | ✅ 完了 |
| RefreshToken | refresh_tokens | ✅ 完了 |

外部データベース:
- 210年節気DB: `solar_terms_1900_2109_JIEQI_ONLY.json`
- 天干地支マトリックス: Pythonコード内（`fortune_analyzer.py`）

---

## 5. 制約事項

### 外部ライブラリ制限
- **lunar-python**: 1900-2100年範囲サポート（210年データベースは2109年まで対応）
- **PostgreSQL**: 同時接続制限あり（Neon無料枠: 1接続）

### 技術的制約
- **データ正確性**: 210年節気データベース範囲内（1900-2109年）でのみ100%正確
- **計算複雑度**: 大運・年月日運・グラフ計算で応答時間が増加する可能性
- **ローカルストレージ**: ブラウザデータクリアで消失

### ドンサゴン分析の絶対禁止事項
- ❌ 五行論（木火土金水、相生相剋）使用禁止
- ❌ 十神論（偏印、正財等）使用禁止
- ❌ 身強・身弱論使用禁止
- ❌ 年柱での用神抽出禁止
- ❌ 月地支は用神不可

### ドンサゴン分析の必須原則
- ✅ 用神 = 武器（不足を補うものではない）
- ✅ 日支の合は無条件吉
- ✅ 調候用神 80% : 原局 20%
- ✅ 天干の合は基本的に凶
- ✅ 月地支は用神不可

---

## 6. API実装状況

**✅ 全APIエンドポイント実装完了（コードが真実源: `backend/app/api/`）**

### 認証API (`/api/auth`)
- `POST /api/auth/register`: 新規登録
- `POST /api/auth/login`: ログイン
- `POST /api/auth/logout`: ログアウト
- `POST /api/auth/refresh`: トークンリフレッシュ

### 命式API (`/api/saju`)
- `POST /api/saju/calculate`: 命式計算
- `POST /api/saju/save`: 命式保存
- `GET /api/saju/list`: 命式一覧
- `GET /api/saju/{id}`: 命式詳細
- `DELETE /api/saju/{id}`: 命式削除
- `GET /api/saju/{id}/daeun`: 大運分析
- `GET /api/saju/current-fortune`: 現在の年月日運（生年月日パラメータ必須）
- `GET /api/saju/{id}/year/{daeun_start_age}`: 年運リスト
- `GET /api/saju/{id}/month/{year}`: 月運リスト
- `GET /api/saju/{id}/day/{year}/{month}`: 日運リスト
- `GET /api/saju/export`: データエクスポート
- `POST /api/saju/migrate`: ゲストデータ移行

### ユーザーAPI (`/api/user`)
- `GET /api/user/me`: ユーザー情報取得（未実装）
- `PUT /api/user/password`: パスワード変更（未実装）

---

## 7. 技術スタック

### フロントエンド
```yaml
フレームワーク: React 18
言語: TypeScript 5
UIライブラリ: MUI v6 (Material-UI)
グラフ: Recharts v3.3.0
状態管理: Zustand
ルーティング: React Router v6
データフェッチ: React Query (TanStack Query)
ビルドツール: Vite 5
ホスティング: Vercel

カスタムテーマ:
  - ゴールドカラーパレット（#D4AF37）
  - 五行カラーシステム
  - golden-peppaアニメーション統合
```

### バックエンド
```yaml
言語: Python 3.11+
フレームワーク: FastAPI 0.100+
ORM: SQLAlchemy 2.0
マイグレーション: Alembic
バリデーション: Pydantic v2
認証: FastAPI-Users + JWT
ホスティング: GCP Cloud Run

既存資産統合:
  - lunar-python（万年暦計算）
  - 210年節気データベース（JSON → PostgreSQL）
  - ドンサゴン分析エンジン
```

### データベース
```yaml
メインDB: PostgreSQL 15+ (Neon)
キャッシュ: Redis (Upstash, オプション)
```

### 開発環境
```yaml
Python: 3.11+
Node.js: 20.x LTS
パッケージマネージャ:
  - Python: Poetry
  - JavaScript: pnpm
コード品質:
  - Python: Black, Ruff, mypy
  - TypeScript: ESLint, Prettier
```

---

## 8. 必要な外部サービス・アカウント

### 必須サービス

| サービス名 | 用途 | 取得先 | 備考 |
|-----------|------|--------|------|
| lunar-python | 万年暦計算ライブラリ | `pip install lunar-python` | 無料、1900-2100年対応 |
| Neon PostgreSQL | メインデータベース | https://neon.tech | 無料枠0.5GB、サーバーレス |
| Vercel | フロントエンドホスティング | https://vercel.com | 無料枠あり、自動デプロイ |
| GCP Cloud Run | バックエンドホスティング | https://cloud.google.com/run | 無料枠月2M req |
| GitHub | コード管理・CI/CD | https://github.com | 無料 |

### オプションサービス

| サービス名 | 用途 | 取得先 | 備考 |
|-----------|------|--------|------|
| Upstash Redis | キャッシュ | https://upstash.com | 無料枠あり、初期不要 |
| Sentry | エラー監視 | https://sentry.io | 無料枠あり、本番後推奨 |

---

## 9. 今後の拡張予定

### Phase 2（中期）
- パスワードリセット機能
- メールアドレス変更機能
- 他のデザインテーマ追加
- 多言語対応（英語・韓国語）

### Phase 3（長期）
- 相性診断機能（2人の命式比較）
- 年運詳細分析
- 択日システム
- モバイルアプリ版（React Native）

---

## 付録：デザイン仕様

### ゴールドカラーパレット（最終版 2025-11-07更新）
```yaml
# プライマリゴールド
PRIMARY_GOLD: #D4AF37      # メインゴールド - ボタン、アイコン、ブランディング
LIGHT_GOLD: #EBCC42        # ライトゴールド - セカンダリボタン、ハイライト
DARK_GOLD: #B8941C         # ダークゴールド - ボタンホバー、シャドウ
PALE_GOLD: #fffbf0         # ペールゴールド - 背景、ホバーエフェクト

# 背景
Background Primary: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%)
Card Background: #FFFFFF
```

### タイポグラフィ（最終版 2025-11-07更新）
```yaml
# ブランドフォント（Golden Peppa ロゴ専用）
Brand Font: 'Indie Flower', cursive
  - Google Fonts CDN: https://fonts.googleapis.com/css2?family=Indie+Flower
  - 特徴: 手書き風、親しみやすい、大人のカジュアル
  - 適用箇所: "Golden Peppa" ロゴタイトルのみ
  - サイズ: xs: 40px, md: 52px, lg: 68px
  - ウェイト: 400
  - レタースペーシング: 1px
  - 色: #D4AF37

# 本文フォント
Primary Font: 'Roboto', 'Noto Sans JP', sans-serif
  - 適用箇所: ボタン、フォーム、ナビゲーション、本文

# 四柱推命表示フォント（任意）
Secondary Font: 'Noto Serif JP', serif
  - 適用箇所: 天干・地支などの伝統的表記
```

### ビジュアルアセット（最終版 2025-11-07更新）
```yaml
# メインロゴ（現行）
Logo Image: /public/images/peppa-with-sparkles.png
  - 説明: ゴールデンペッパーミル + キラキラエフェクト統合画像
  - サイズ: xs: 160px, md: 200px, lg: 240px
  - 配置: 中央揃え（display: block, margin: auto）
  - 変更日: 2025-11-07
  - 変更理由: レイアウト安定性向上（5枚→1枚統合）

# 旧アセット（非推奨、ローディングアニメーションでのみ使用）
Old Assets:
  - /public/images/peppa.png
  - /public/images/キラキラ1.png
  - /public/images/キラキラ2.png
  - /public/images/キラキラ3.png
  - /public/images/キラキラ4.png
  - /public/images/左下光線.png
  - /public/images/右上光線.png
```

### 五行カラーシステム
```yaml
木: #4CAF50（緑）
火: #F44336（赤）
土: #FFB300（黄/オレンジ）
金: #BDBDBD（グレー/白）
水: #424242（黒/ダークグレー）
```

### 吉凶カラーシステム（7段階）
```yaml
大吉: #FFD700（ゴールド）
小吉: #4CAF50（緑）
吉: #4CAF50（緑）
吉凶: #9E9E9E（グレー）
平: #9E9E9E（グレー）
凶: #FF9800（オレンジ）
大凶: #F44336（赤）
```

**注**: FortuneLevel型は7段階だが、表示上は5色で視覚化（小吉=吉、吉凶=平）

---

## 10. UI/UXデザイン指針

**✅ コア機能・レスポンシブ対応完了（2025-11-09更新）**

### 実装済み
- ✅ Golden Peppaローディングアニメーション
- ✅ ゴールドテーマボタン（プライマリ・セカンダリ）
- ✅ カードホバーエフェクト
- ✅ レスポンシブ対応（xs/sm/md/lg/xl）完全実装
- ✅ 統一デザインシステム（`cardStyles.ts`）
- ✅ 命式表示の視認性向上（1.5倍拡大）
- ✅ 大運表示最適化（開始年齢表記）
- ✅ 水平スクロール対応（大運・年月日運セクション）
- ✅ タップ領域最適化（Apple HIG準拠、最小48px）
- ✅ エラー表示（Alert/FormHelperText）
- ✅ 削除確認ダイアログ
- ✅ デバッグログ（開発時）

### Phase 2以降で実装予定
- ⏳ Snackbarトースト通知（保存成功・削除成功等）
- ⏳ ページ遷移アニメーション
- ⏳ ARIA属性の完全対応（現状42%）
- ⏳ タッチジェスチャー（スワイプ削除等）
- ⏳ 画像最適化（WebP形式への変換）

詳細な実装基準はコードを参照：
- アニメーション: `frontend/src/components/GoldenPeppaLoading.tsx`
- デザインシステム: `frontend/src/constants/cardStyles.ts`
- テーマ: `frontend/src/App.tsx`（MUIテーマ設定）
- レスポンシブ: 各ページコンポーネントのsx prop

---

**作成日**: 2025年11月1日
**バージョン**: 1.2（モバイルレスポンシブ対応・吉凶判定ロジック修正完了）
**最終更新**: 2025年11月9日

---

## 🆕 最新アップデート（2025-11-09）

### モバイルレスポンシブ対応完了
- ✅ 命式（四柱）表示を1.5倍に拡大（視認性向上）
- ✅ 大運表示を年代形式から開始年齢表記に変更（6, 16, 26...）
- ✅ 全セクションに統一デザインシステム（`cardStyles.ts`）導入
- ✅ 水平スクロール対応（大運・年月日運セクション）
- ✅ タップ領域最適化（Apple HIG準拠、最小48px）
- ✅ 人生グラフのモバイル表示最適化

### 吉凶判定ロジック修正
- ✅ バックエンド：`current-fortune` APIに生年月日パラメータ追加
- ✅ ユーザーの日干を基準にした正確な吉凶判定を実装
- ✅ FortuneLevel型の拡張（7段階：大吉・小吉・吉・吉凶・平・凶・大凶）
- ✅ フロントエンド：型安全性向上とデフォルト値設定
- ✅ デバッグログ追加（開発時）

### デプロイ状況
- フロントエンド: https://frontend-amis-projects-474dde3c.vercel.app
- バックエンド: https://golden-saju-api-235426778039.asia-northeast1.run.app
- コミットハッシュ: `4d82593`

---

## 🔜 今後の実装予定

### Phase 2（短期）
- パスワードリセット機能
- メールアドレス変更機能
- Snackbarトースト通知
- ARIA属性の完全対応

### Phase 3（中長期）
- 相性診断機能（2人の命式比較）
- 年運詳細分析
- 択日システム
- モバイルアプリ版（React Native）

