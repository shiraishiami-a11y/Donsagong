<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>新規登録 - ゴールデン四柱推命</title>

  <!-- MUI v7 -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #FAFAFA 0%, #F4E8C1 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ゴールドカラーパレット */
    :root {
      --primary-gold: #D4AF37;
      --light-gold: #F4E8C1;
      --dark-gold: #B8941C;
      --white: #FFFFFF;
      --gray-light: #FAFAFA;
      --gray-medium: #9E9E9E;
      --gray-dark: #424242;
      --error-red: #F44336;
      --success-green: #4CAF50;
      --warning-orange: #FF9800;
    }

    /* ヘッダー */
    header {
      background-color: var(--white);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      text-decoration: none;
      color: var(--gray-dark);
      transition: color 0.3s;
    }

    .header-left:hover {
      color: var(--primary-gold);
    }

    .back-icon {
      font-size: 24px;
    }

    .logo {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary-gold);
      text-align: center;
      flex: 1;
    }

    .header-right {
      width: 32px; /* ヘッダーバランス用 */
    }

    /* メインコンテンツ */
    main {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .register-container {
      background: var(--white);
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      padding: 32px 24px;
      width: 100%;
      max-width: 430px;
      animation: fadeInUp 0.5s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* セクション1: タイトル */
    .title-section {
      text-align: center;
      margin-bottom: 32px;
    }

    .title {
      font-size: 28px;
      font-weight: 700;
      color: var(--gray-dark);
      margin-bottom: 8px;
    }

    .subtitle {
      font-size: 14px;
      color: var(--gray-medium);
    }

    /* セクション2: フォーム */
    .form-section {
      margin-bottom: 24px;
    }

    .form-group {
      margin-bottom: 24px;
    }

    label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-dark);
      margin-bottom: 8px;
    }

    .input-wrapper {
      position: relative;
    }

    input[type="email"],
    input[type="password"] {
      width: 100%;
      padding: 14px 16px;
      font-size: 16px;
      border: 1px solid #E0E0E0;
      border-radius: 8px;
      transition: all 0.3s;
      font-family: 'Roboto', sans-serif;
    }

    input[type="email"]:focus,
    input[type="password"]:focus {
      outline: none;
      border-color: var(--primary-gold);
      box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
    }

    input[type="password"] {
      padding-right: 48px; /* 目アイコン用スペース */
    }

    .toggle-password {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      color: var(--gray-medium);
      transition: color 0.3s;
    }

    .toggle-password:hover {
      color: var(--primary-gold);
    }

    .material-icons {
      font-size: 20px;
    }

    /* パスワード強度インジケーター */
    .password-strength {
      margin-top: 8px;
      display: flex;
      gap: 4px;
      height: 4px;
    }

    .strength-bar {
      flex: 1;
      background-color: #E0E0E0;
      border-radius: 2px;
      transition: background-color 0.3s;
    }

    .strength-bar.active-weak {
      background-color: var(--error-red);
    }

    .strength-bar.active-medium {
      background-color: var(--warning-orange);
    }

    .strength-bar.active-strong {
      background-color: var(--success-green);
    }

    .strength-text {
      font-size: 12px;
      margin-top: 4px;
      color: var(--gray-medium);
    }

    /* エラーメッセージ */
    .error-message {
      font-size: 12px;
      color: var(--error-red);
      margin-top: 4px;
      display: none;
    }

    input.error {
      border-color: var(--error-red);
    }

    input.error:focus {
      box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.1);
    }

    input.error ~ .error-message {
      display: block;
    }

    /* チェックボックス */
    .checkbox-wrapper {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 24px;
    }

    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-top: 2px;
      cursor: pointer;
      accent-color: var(--primary-gold);
    }

    .checkbox-label {
      flex: 1;
      font-size: 14px;
      color: var(--gray-dark);
      line-height: 1.5;
    }

    .checkbox-description {
      font-size: 12px;
      color: var(--gray-medium);
      margin-top: 4px;
    }

    /* セクション3: ボタン */
    .button-section {
      margin-bottom: 24px;
    }

    .register-button {
      width: 100%;
      padding: 16px;
      font-size: 16px;
      font-weight: 700;
      color: var(--white);
      background: linear-gradient(135deg, var(--primary-gold) 0%, var(--dark-gold) 100%);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
    }

    .register-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(212, 175, 55, 0.4);
    }

    .register-button:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(212, 175, 55, 0.3);
    }

    .register-button:disabled {
      background: var(--gray-medium);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* セクション4: フッター */
    .footer-section {
      text-align: center;
      font-size: 14px;
      color: var(--gray-medium);
    }

    .login-link {
      color: var(--primary-gold);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s;
    }

    .login-link:hover {
      color: var(--dark-gold);
      text-decoration: underline;
    }

    /* キラキラエフェクト（ホバー時） */
    @keyframes sparkle {
      0%, 100% { opacity: 0; }
      50% { opacity: 1; }
    }

    .register-button::before {
      content: '✨';
      position: absolute;
      opacity: 0;
      animation: sparkle 2s infinite;
    }

    /* レスポンシブ対応 */
    @media (max-width: 430px) {
      .register-container {
        padding: 24px 20px;
      }

      .title {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <!-- ヘッダー -->
  <header>
    <a href="/" class="header-left">
      <span class="material-icons back-icon">arrow_back</span>
    </a>
    <div class="logo">ゴールデン四柱推命</div>
    <div class="header-right"></div>
  </header>

  <!-- メインコンテンツ -->
  <main>
    <div class="register-container">
      <!-- セクション1: タイトル -->
      <div class="title-section">
        <h1 class="title">新規登録</h1>
        <p class="subtitle">アカウントを作成して、どこからでもアクセス</p>
      </div>

      <!-- セクション2: フォーム -->
      <form class="form-section" id="registerForm">
        <!-- メールアドレス -->
        <div class="form-group">
          <label for="email">メールアドレス</label>
          <div class="input-wrapper">
            <input
              type="email"
              id="email"
              name="email"
              placeholder="example@email.com"
              required
            />
            <span class="error-message" id="emailError">有効なメールアドレスを入力してください</span>
          </div>
        </div>

        <!-- パスワード -->
        <div class="form-group">
          <label for="password">パスワード</label>
          <div class="input-wrapper">
            <input
              type="password"
              id="password"
              name="password"
              placeholder="パスワード（8文字以上）"
              required
            />
            <button type="button" class="toggle-password" onclick="togglePassword('password')">
              <span class="material-icons" id="passwordIcon">visibility_off</span>
            </button>
            <span class="error-message" id="passwordError">8文字以上のパスワードを入力してください</span>
          </div>
          <!-- パスワード強度インジケーター -->
          <div class="password-strength" id="passwordStrength">
            <div class="strength-bar"></div>
            <div class="strength-bar"></div>
            <div class="strength-bar"></div>
          </div>
          <div class="strength-text" id="strengthText"></div>
        </div>

        <!-- パスワード確認 -->
        <div class="form-group">
          <label for="passwordConfirm">パスワード（確認）</label>
          <div class="input-wrapper">
            <input
              type="password"
              id="passwordConfirm"
              name="passwordConfirm"
              placeholder="パスワード（確認）"
              required
            />
            <button type="button" class="toggle-password" onclick="togglePassword('passwordConfirm')">
              <span class="material-icons" id="passwordConfirmIcon">visibility_off</span>
            </button>
            <span class="error-message" id="passwordConfirmError">パスワードが一致しません</span>
          </div>
        </div>

        <!-- ゲストデータ移行チェックボックス -->
        <div class="checkbox-wrapper">
          <input
            type="checkbox"
            id="migrateData"
            name="migrateData"
            checked
          />
          <div class="checkbox-label">
            <label for="migrateData">ゲストデータを移行する</label>
            <div class="checkbox-description">このデバイスに保存された命式をクラウドに移行します</div>
          </div>
        </div>

        <!-- セクション3: ボタン -->
        <div class="button-section">
          <button type="submit" class="register-button">登録</button>
        </div>
      </form>

      <!-- セクション4: フッター -->
      <div class="footer-section">
        <p>
          すでにアカウントをお持ちの方
          <a href="/login" class="login-link">ログインはこちら</a>
        </p>
      </div>
    </div>
  </main>

  <!--
  【CF_06引き継ぎ情報】

  ## 新規登録API

  UI要件: メールアドレスとパスワードでアカウント作成、ゲストデータの任意移行

  必要API: POST /api/auth/register
  入力データ: {
    email: string (required, メール形式バリデーション),
    password: string (required, 8文字以上),
    migrate_data: boolean (optional, デフォルトtrue)
  }
  出力データ: {
    access_token: string (JWT, 有効期限15分),
    refresh_token: string (有効期限7日/30日/無期限),
    token_type: "bearer",
    user: {
      id: string (UUID),
      email: string,
      created_at: datetime
    }
  }

  UI文脈:
  - フォーム送信 → ローディング表示 → 成功時にトークンをLocalStorageに保存 → /listにリダイレクト
  - ゲストデータ移行ONの場合、登録成功後に自動的に移行処理を実行
  - エラー時は該当フィールドに赤枠とエラーメッセージ表示

  特記事項:
  - パスワードはbcryptでハッシュ化してDB保存
  - メールアドレスの重複チェック（既存の場合はエラー返却）
  - Refresh Token rotationによるセキュリティ強化

  ## ゲストデータ移行API

  UI要件: LocalStorageの命式データをPostgreSQLに移行

  必要API: POST /api/saju/migrate
  入力データ: {
    user_id: string (UUID, JWT から取得),
    local_data: Array<{
      name: string | null,
      birth_datetime: datetime,
      gender: "male" | "female",
      year_stem: string,
      year_branch: string,
      month_stem: string,
      month_branch: string,
      day_stem: string,
      day_branch: string,
      hour_stem: string,
      hour_branch: string,
      fortune_level: string,
      created_at: datetime
    }>
  }
  出力データ: {
    migrated_count: number,
    success: boolean,
    message: string
  }

  UI文脈:
  - 新規登録成功後、migrate_data=trueの場合に自動実行
  - LocalStorageからすべての命式データを取得してバックエンドに送信
  - トランザクション管理（全成功または全失敗）
  - 移行完了後、LocalStorageデータは保持（削除しない）

  特記事項:
  - 非同期処理、ローディング表示必須
  - データサイズ制限（最大100件まで）
  - エラー時はロールバック
  -->

  <script>
    // パスワード表示/非表示切り替え
    function togglePassword(fieldId) {
      const input = document.getElementById(fieldId);
      const icon = document.getElementById(fieldId + 'Icon');

      if (input.type === 'password') {
        input.type = 'text';
        icon.textContent = 'visibility';
      } else {
        input.type = 'password';
        icon.textContent = 'visibility_off';
      }
    }

    // パスワード強度チェック
    const passwordInput = document.getElementById('password');
    const strengthBars = document.querySelectorAll('.strength-bar');
    const strengthText = document.getElementById('strengthText');

    passwordInput.addEventListener('input', function() {
      const password = this.value;
      let strength = 0;

      if (password.length >= 8) strength++;
      if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
      if (password.match(/[0-9]/)) strength++;
      if (password.match(/[^a-zA-Z0-9]/)) strength++;

      // 強度表示をリセット
      strengthBars.forEach(bar => {
        bar.classList.remove('active-weak', 'active-medium', 'active-strong');
      });

      if (strength === 0 || password.length === 0) {
        strengthText.textContent = '';
      } else if (strength <= 2) {
        strengthBars[0].classList.add('active-weak');
        strengthText.textContent = '弱い';
        strengthText.style.color = '#F44336';
      } else if (strength === 3) {
        strengthBars[0].classList.add('active-medium');
        strengthBars[1].classList.add('active-medium');
        strengthText.textContent = '中';
        strengthText.style.color = '#FF9800';
      } else {
        strengthBars[0].classList.add('active-strong');
        strengthBars[1].classList.add('active-strong');
        strengthBars[2].classList.add('active-strong');
        strengthText.textContent = '強い';
        strengthText.style.color = '#4CAF50';
      }
    });

    // フォームバリデーション
    const form = document.getElementById('registerForm');
    const emailInput = document.getElementById('email');
    const passwordConfirmInput = document.getElementById('passwordConfirm');

    form.addEventListener('submit', function(e) {
      e.preventDefault();

      let isValid = true;

      // メールアドレスバリデーション
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(emailInput.value)) {
        emailInput.classList.add('error');
        isValid = false;
      } else {
        emailInput.classList.remove('error');
      }

      // パスワード長さチェック
      if (passwordInput.value.length < 8) {
        passwordInput.classList.add('error');
        isValid = false;
      } else {
        passwordInput.classList.remove('error');
      }

      // パスワード一致チェック
      if (passwordInput.value !== passwordConfirmInput.value) {
        passwordConfirmInput.classList.add('error');
        isValid = false;
      } else {
        passwordConfirmInput.classList.remove('error');
      }

      if (isValid) {
        // 実際のAPI呼び出し処理
        const formData = {
          email: emailInput.value,
          password: passwordInput.value,
          migrate_data: document.getElementById('migrateData').checked
        };

        console.log('登録データ:', formData);
        alert('登録ボタンがクリックされました！\n（実際の実装ではAPI呼び出しが行われます）');

        // 実装時のコード例:
        // fetch('/api/auth/register', {
        //   method: 'POST',
        //   headers: { 'Content-Type': 'application/json' },
        //   body: JSON.stringify(formData)
        // })
        // .then(response => response.json())
        // .then(data => {
        //   localStorage.setItem('access_token', data.access_token);
        //   localStorage.setItem('refresh_token', data.refresh_token);
        //
        //   if (formData.migrate_data) {
        //     // ゲストデータ移行処理
        //     migrateGuestData(data.user.id);
        //   }
        //
        //   window.location.href = '/list';
        // })
        // .catch(error => {
        //   console.error('登録エラー:', error);
        // });
      }
    });

    // エラー表示をクリア（入力時）
    [emailInput, passwordInput, passwordConfirmInput].forEach(input => {
      input.addEventListener('input', function() {
        this.classList.remove('error');
      });
    });
  </script>
</body>
</html>
